# DigiKaksha AI Coding Agent Instructions

## Project Overview
DigiKaksha is a FastAPI-based smart classroom management system with three main components:
1. **Face Recognition Attendance** (`face.py`) - OpenCV + dlib-based automatic attendance tracking
2. **Student Performance Analysis** (`app.py` routes: `/analyze_individual`, `/analyze_all`) - Matplotlib visualization of MongoDB data
3. **RAG-powered Study Chatbot** (`app.py` routes: `/upload`, `/ask`) - LangChain + Google Gemini for PDF Q&A

## Critical Setup Requirements

### Python Environment
- Use **Python 3.11.x** (3.12+ has compatibility issues with some deps).
- Local venv path on this repo: `/Users/ravikantsaraf/Desktop/kakshaa/DigiKaksha/venv/bin/python`.
- System prereqs for dlib build:
	- macOS: `brew install cmake`
	- Ubuntu: `sudo apt-get install -y cmake build-essential`
	- Windows (CI or dev): ensure CMake in PATH and VS Build Tools with C++ workload; GitHub Actions runner includes VS, we also install CMake via Chocolatey.

### API Keys (Required)
- Use a `.env` file in repo root (not committed) and restart the app after editing.
```
LANGCHAIN_TRACING_V2=<your-langsmith-key>
GOOGLE_API_KEY=<your-gemini-key>
EMBED_MODEL_ID=Qwen/Qwen3-Embedding-0.6B  # Optional: override default embedding model
```
The app loads these with `python-dotenv` in `app.py`.

### MongoDB Setup
- Default connection: `mongodb://localhost:27017/`
- Database: `education`, Collection: `students`
- Schema example in `students.performance.json` - nested structure with `marks.{subject}` and `attendance_percentage.{subject}`

## Key Architecture Patterns

### Session Management
- Uses Starlette's `SessionMiddleware` with hardcoded secret: `'your_secret_key'`
- Session-based auth (not JWT): `request.session['username']` for login state
- Hardcoded users dict in `app.py` lines 37-41 (USN → password mapping)

### Face Recognition Flow
- Known faces stored as JPG/PNG in `known_faces/` directory (filename = student name)
- `face.py` runs as subprocess via `/run-face-recognition` endpoint: `subprocess.call(['python', 'face.py'])`
- Attendance written to `attendance.csv` with timestamp on ESC key press
- Uses dual camera fallback: tries external (index 1) → built-in (index 0)

### RAG Pipeline (Study Chatbot)
- PDF upload triggers processing: Docling `DocumentConverter` → Markdown → `MarkdownHeaderTextSplitter` → `RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)` → `Chroma` vectorstore in `./VectorDB/`
- Embeddings: HuggingFace `Qwen/Qwen3-Embedding-0.6B` model (configurable via EMBED_MODEL_ID env var)
- Prompt template: ChatPromptTemplate with system + human messages
- Global `retriever` variable initialized on first upload

### Graph Generation
- Matplotlib uses `'Agg'` backend (line 2) for non-GUI rendering
- Plots saved to `static/{usn}_{marks|attendance}_{bar|pie}.png`
- Subject list hardcoded (lines 171, 241): `["MATHS", "IDS", "DBMS", "DAA", "CN", "MONGODB"]`

## Common Tasks

### Running the App
```bash
cd /Users/ravikantsaraf/Desktop/kakshaa/DigiKaksha
source venv/bin/activate  # or use full path to python
python app.py  # Starts uvicorn on http://localhost:8000
```

### Adding New Students
1. Place student photo in `known_faces/{StudentName}.jpg`
2. Add MongoDB document matching schema in `students.performance.json`
3. Add USN/password to `users` dict in `app.py`

### Debugging Face Recognition
- Check camera indices if failing: modify `cv2.VideoCapture(1)` → `VideoCapture(0)` in `face.py` line 51
- Face detection model files: `deploy.prototxt`, `res10_300x300_ssd_iter_140000_fp16.caffemodel` (required in root)
- Confidence threshold: `conf_threshold = 0.7` (line 60)

## CI and Cross-Platform Setup
- GitHub Actions workflow: `.github/workflows/ci.yml`
	- Jobs for macOS and Ubuntu install system deps (CMake) then `pip install -r requirements.txt`, followed by sanity imports (`cv2`, `dlib`, `face_recognition`, `langchain`, `chromadb`).
	- Windows job runs with `continue-on-error: true` since `dlib` may require additional Visual C++ components; use as advisory.
- For deterministic builds, prefer Python 3.11 and keep `requirements.txt` stable; if updating, validate CI across OS.

## File Structure Notes
- `templates/` - Jinja2 HTML templates (login, homepage, ask, graph_entry, graph_details, upload_file)
- `static/` - CSS + generated graph images
- `uploads/` - Temporary PDF storage for RAG processing
- `VectorDB/` - Chroma persistent embeddings
- `attendance.csv` - Generated by `face.py` on each run (overwrites previous)

## Conventions
- API keys come from `.env` loaded via `python-dotenv`; avoid committing secrets
- No TypeScript/build steps - pure Python backend with Jinja2 templates
- MongoDB queries use `pd.json_normalize()` for nested field flattening (line 63)
- Route protection: manual session check `if 'username' not in request.session: return RedirectResponse(url='/login')`
